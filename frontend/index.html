<!DOCTYPE html>
<html>

<head>
    <title>Japanese Writing Game</title>
    <link rel="stylesheet" href="css/index.css">
</head>

<body>

    <div class="container">
        <button id="kanji-mode">Kanji Mode</button>
        <button id="katakana-mode">Katakana Mode</button>
        <button id="hiragana-mode">Hiragana Mode</button>
        <a href="ankilike.html">Anki Like Mode</a>
    </div>

    <div class="container">
        <div id="health-display">
            <span class="health-label">Health: </span>
            <span id="health-hearts"></span>
        </div>
        <h2 id="mode-title">Draw the <span id="writing-type">Kanji</span> for: <span id="word-display"></span></h2>
        <canvas id="draw" width="300" height="300"></canvas><br>
        <div>
            <button id="clear">Clear</button>
            <button id="submit">Submit</button>
            <button id="show-answer-button"><span id="show-text">Show </span>the answer</button>
        </div>
        <h3 id="answers">Answers Character: <span id="target-char"></span></h3>

        <div id="result-card">
            <p><span class="label">Correct:</span> <span id="correct"></span></p>
            <p><span class="label" id="detected-label">Detected Kanji:</span> <span id="detected"></span></p>
            <p><span class="label">Reason:</span> <span id="reason"></span></p>
            <p><span class="label">Hiragana:</span> <span id="pronouce_in_hiragana"></span></p>
            <p><span class="label">Romanji:</span> <span id="pronouce_in_romanji"></span></p>
            <button onclick="nextWord()" id="next-button">Next Kanji</button>
        </div>

        <div id="game-over-message"
            style="display: none; margin-top: 20px; padding: 20px; background: #ffebee; border-radius: 10px; border: 2px solid #f44336;">
            <h2 style="color: #d32f2f;">Game Over!</h2>
            <p>You've run out of health. Click a mode button to start a new game.</p>
        </div>
    </div>

    <script>
        let dictionary = {};
        let currentMode = "kanji"; // default
        let currentItem = null;
        let health = 3; // Health system: start with 3 lives

        // UI elements
        const modeTitle = document.getElementById("mode-title");
        const detectedLabel = document.getElementById("detected-label");
        const writingType = document.getElementById("writing-type");
        const wordDisplay = document.getElementById("word-display");
        const healthHearts = document.getElementById("health-hearts");

        // Canvas
        const canvas = document.getElementById("draw");
        const ctx = canvas.getContext("2d");
        let drawing = false;

        // Update health display
        function updateHealthDisplay() {
            let heartsHTML = "";
            for (let i = 0; i < health; i++) {
                heartsHTML += "â¤ï¸";
            }
            for (let i = health; i < 3; i++) {
                heartsHTML += "ðŸ¤";
            }
            healthHearts.textContent = heartsHTML;
        }

        // Initialize health display
        updateHealthDisplay();

        fetch("data.json").then(res => res.json()).then(data => {
            dictionary = data;
            nextWord();
        })
            .catch(err => console.error("Failed to load data:", err));

        function hideAnswers() {
            document.getElementById("answers").style.display = "none";
            document.getElementById("show-text").textContent = "Show ";
        }
        // ---- Pick a random word ----
        function nextWord() {
            // Check if game is over
            if (health <= 0) {
                return; // Don't proceed if game is over
            }

            const list = dictionary[currentMode];
            currentItem = list[Math.floor(Math.random() * list.length)];


            // Show English meaning
            wordDisplay.textContent = currentItem.english;

            // Save the correct Kanji/Kana to send to backend
            document.getElementById("target-char").textContent = currentItem.kanji || currentItem.kana;

            // Clear canvas + results
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            document.getElementById("result-card").style.display = "none";
            hideAnswers();
        }

        // Show answers
        document.getElementById("show-answer-button").onclick = () => {
            var showAnswers = document.getElementById("answers")
            if (showAnswers.style.display == "none") {
                showAnswers.style.display = "block";
                document.getElementById("show-text").textContent = "Hide "
            } else {
                hideAnswers();
            }
        };

        // Reset health and game
        function resetGame() {
            health = 3;
            updateHealthDisplay();
            document.getElementById("game-over-message").style.display = "none";
            document.getElementById("submit").disabled = false;
            document.getElementById("next-button").disabled = false;
        }

        // Mode switching
        document.getElementById("kanji-mode").onclick = () => {
            writingType.textContent = "Kanji";
            currentMode = "kanji";
            resetGame();
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            nextWord();
            document.getElementById("result-card").style.display = "none";
            hideAnswers();
        };

        document.getElementById("hiragana-mode").onclick = () => {
            writingType.textContent = "Hiragana";
            currentMode = "hiragana";
            resetGame();
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            nextWord();
            document.getElementById("result-card").style.display = "none";
            hideAnswers();
        };

        document.getElementById("katakana-mode").onclick = () => {
            writingType.textContent = "Katakana";
            currentMode = "katakana";
            resetGame();
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            nextWord();
            document.getElementById("result-card").style.display = "none";
            hideAnswers();
        };

        // Canvas drawing handling
        canvas.addEventListener("mousedown", (e) => {
            drawing = true;
            ctx.beginPath();
            ctx.moveTo(e.offsetX, e.offsetY);
        });

        canvas.addEventListener("mouseup", () => drawing = false);
        canvas.addEventListener("mouseout", () => drawing = false);

        canvas.addEventListener("mousemove", (e) => {
            if (!drawing) return;
            ctx.lineWidth = 8;
            ctx.lineCap = "round";
            ctx.lineJoin = "round";
            ctx.lineTo(e.offsetX, e.offsetY);
            ctx.stroke();
        });

        document.getElementById("clear").onclick = () => {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
        };

        // Submit handler
        document.getElementById("submit").onclick = async () => {
            const target_word = wordDisplay.textContent;
            const base64 = canvas.toDataURL("image/png").split(",")[1];

            let url = "";

            if (currentMode === "kanji") {
                url = "http://localhost:6767/grade-kanji";
            } else if (currentMode === "katakana") {
                url = "http://localhost:6767/grade-katakana"
            } else if (currentMode === "hiragana") {
                url = "http://localhost:6767/grade-hiragana"
            }

            const res = await fetch(url, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ target_word, image: base64 })
            });

            const data = await res.json();

            // Handle health system: lose health if wrong
            if (!data.correct) {
                health--;
                updateHealthDisplay();

                // Check for game over
                if (health <= 0) {
                    document.getElementById("game-over-message").style.display = "block";
                    document.getElementById("submit").disabled = true;
                    document.getElementById("next-button").disabled = true;
                }
            }

            // Display results
            document.getElementById("result-card").style.display = "block";
            document.getElementById("correct").textContent = data.correct;
            document.getElementById("correct").className = data.correct ? "correct-true" : "correct-false";

            // check the mode
            if (currentMode === "kanji") {
                document.getElementById("detected").textContent = data.kanji_detected;
            } else if (currentMode === "katakana") {
                document.getElementById("detected").textContent = data.katakana_detected;
            } else if (currentMode === "hiragana") {
                document.getElementById("detected").textContent = data.hiragana_detected;
            }

            document.getElementById("pronouce_in_hiragana").textContent = data.pronouce_in_hiragana;
            document.getElementById("pronouce_in_romanji").textContent = data.pronouce_in_romanji;

            document.getElementById("reason").textContent = data.reason;
        };
    </script>

</body>

</html>